// Ensure the global `wp` object exists.
window.wp=window.wp||{};(function(e){var t={},n={};wp.mce=wp.mce||{};wp.mce.view={defaults:{pattern:{view:Backbone.View,text:function(e){return e.options.original},toView:function(e){if(!this.pattern)return;this.pattern.lastIndex=0;var t=this.pattern.exec(e);if(!t)return;return{index:t.index,content:t[0],options:{original:t[0],results:t}}}},shortcode:{view:Backbone.View,text:function(e){return e.options.shortcode.string()},toView:function(e){var t=wp.shortcode.next(this.shortcode,e);if(!t)return;return{index:t.index,content:t.content,options:{shortcode:t.shortcode}}}}},add:function(e,r){var i,s,o,u;r.extend?i=wp.mce.view.get(r.extend):r.shortcode?i=wp.mce.view.defaults.shortcode:i=wp.mce.view.defaults.pattern;_.defaults(r,i);r.id=e;u={remove:function(){delete n[this.el.id];this.$el.parent().remove();s&&s.apply(this,arguments);return this}};if(_.isFunction(r.view))o=r.view;else{o=i.view;s=r.view.remove;_.defaults(u,r.view)}!s&&!o._mceview&&(s=o.prototype.remove);r.view=o.extend(u,{_mceview:!0});t[e]=r},get:function(e){return t[e]},remove:function(e){delete t[e]},toViews:function(e){var n=[{content:e}],r;_.each(t,function(e,t){r=n.slice();n=[];_.each(r,function(r){var i=r.content,s;if(r.processed){n.push(r);return}while(i&&(s=e.toView(i))){s.index&&n.push({content:i.substring(0,s.index)});n.push({content:wp.mce.view.toView(t,s.options),processed:!0});i=i.slice(s.index+s.content.length)}i&&n.push({content:i})})});return _.pluck(n,"content").join("")},toView:function(t,r){var i=wp.mce.view.get(t),s,o;if(!i)return"";s=new i.view(_.extend(r||{},{viewType:t}));o=s.el.id=s.el.id||_.uniqueId("__wpmce-");n[o]=s;s.$wrapper=e();return wp.html.string({tag:"span"===s.tagName?"span":"div",attrs:{"class":"wp-view-wrap wp-view-type-"+t,"data-wp-view":o,contenteditable:!1}})},render:function(t){e(".wp-view-wrap",t).each(function(){var t=e(this),n=wp.mce.view.instance(this);if(!n)return;n.$wrapper=t;n.render();n.$el.detach();t.empty().append(n.el).append('<span data-wp-view-end class="wp-view-end"></span>')})},toText:function(e){return e.replace(/<(?:div|span)[^>]+data-wp-view="([^"]+)"[^>]*>.*?<span[^>]+data-wp-view-end[^>]*><\/span><\/(?:div|span)>/g,function(e,t){var r=n[t],i;r&&(i=wp.mce.view.get(r.options.viewType));return r&&i?i.text(r):""})},removeInternalAttrs:function(e){var t={};_.each(e,function(e,n){-1===n.indexOf("data-mce")&&(t[n]=e)});return t},attrs:function(e){return wp.mce.view.removeInternalAttrs(wp.html.attrs(e))},instance:function(t){var r=e(t).data("wp-view");if(r)return n[r]},select:function(t){var n=e(t);if(n.hasClass("selected"))return;n.addClass("selected");e(t.firstChild).trigger("select")},deselect:function(t){var n=e(t);if(!n.hasClass("selected"))return;n.removeClass("selected");e(t.firstChild).trigger("deselect")}}})(jQuery);