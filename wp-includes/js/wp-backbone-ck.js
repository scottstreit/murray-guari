window.wp=window.wp||{};(function(e){wp.Backbone={};wp.Backbone.Subviews=function(e,t){this.view=e;this._views=_.isArray(t)?{"":t}:t||{}};wp.Backbone.Subviews.extend=Backbone.Model.extend;_.extend(wp.Backbone.Subviews.prototype,{all:function(){return _.flatten(this._views)},get:function(e){e=e||"";return this._views[e]},first:function(e){var t=this.get(e);return t&&t.length?t[0]:null},set:function(e,t,n){var r,i;if(!_.isString(e)){n=t;t=e;e=""}n=n||{};t=_.isArray(t)?t:[t];r=this.get(e);i=t;if(r)if(n.add)if(_.isUndefined(n.at))i=r.concat(t);else{i=r;i.splice.apply(i,[n.at,0].concat(t))}else{_.each(i,function(e){e.__detach=!0});_.each(r,function(e){e.__detach?e.$el.detach():e.remove()});_.each(i,function(e){delete e.__detach})}this._views[e]=i;_.each(t,function(t){var n=t.Views||wp.Backbone.Subviews,r=t.views=t.views||new n(t);r.parent=this.view;r.selector=e},this);n.silent||this._attach(e,t,_.extend({ready:this._isReady()},n));return this},add:function(e,t,n){if(!_.isString(e)){n=t;t=e;e=""}return this.set(e,t,_.extend({add:!0},n))},unset:function(e,t,n){var r;if(!_.isString(e)){n=t;t=e;e=""}t=t||[];if(r=this.get(e)){t=_.isArray(t)?t:[t];this._views[e]=t.length?_.difference(r,t):[]}(!n||!n.silent)&&_.invoke(t,"remove");return this},detach:function(){e(_.pluck(this.all(),"el")).detach();return this},render:function(){var e={ready:this._isReady()};_.each(this._views,function(t,n){this._attach(n,t,e)},this);this.rendered=!0;return this},remove:function(e){if(!e||!e.silent){this.parent&&this.parent.views&&this.parent.views.unset(this.selector,this.view,{silent:!0});delete this.parent;delete this.selector}_.invoke(this.all(),"remove");this._views=[];return this},replace:function(e,t){e.html(t);return this},insert:function(e,t,n){var r=n&&n.at,i;_.isNumber(r)&&(i=e.children()).length>r?i.eq(r).before(t):e.append(t);return this},ready:function(){this.view.trigger("ready");_.chain(this.all()).map(function(e){return e.views}).flatten().where({attached:!0}).invoke("ready")},_attach:function(e,t,n){var r=e?this.view.$(e):this.view.$el,i;if(!r.length)return this;i=_.chain(t).pluck("views").flatten().value();_.each(i,function(e){if(e.rendered)return;e.view.render();e.rendered=!0},this);this[n.add?"insert":"replace"](r,_.pluck(t,"el"),n);_.each(i,function(e){e.attached=!0;n.ready&&e.ready()},this);return this},_isReady:function(){var e=this.view.el;while(e){if(e===document.body)return!0;e=e.parentNode}return!1}});wp.Backbone.View=Backbone.View.extend({Subviews:wp.Backbone.Subviews,constructor:function(){this.views=new this.Subviews(this,this.views);this.on("ready",this.ready,this);Backbone.View.apply(this,arguments)},remove:function(){var e=Backbone.View.prototype.remove.apply(this,arguments);this.views&&this.views.remove();return e},render:function(){var e;this.prepare&&(e=this.prepare());this.views.detach();if(this.template){e=e||{};this.trigger("prepare",e);this.$el.html(this.template(e))}this.views.render();return this},prepare:function(){return this.options},ready:function(){}})})(jQuery);