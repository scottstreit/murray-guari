window.wp=window.wp||{},function(e){wp.Backbone={},wp.Backbone.Subviews=function(e,t){this.view=e,this._views=_.isArray(t)?{"":t}:t||{}},wp.Backbone.Subviews.extend=Backbone.Model.extend,_.extend(wp.Backbone.Subviews.prototype,{all:function(){return _.flatten(this._views)},get:function(e){return e=e||"",this._views[e]},first:function(e){var t=this.get(e);return t&&t.length?t[0]:null},set:function(e,t,n){var r,i;return _.isString(e)||(n=t,t=e,e=""),n=n||{},t=_.isArray(t)?t:[t],r=this.get(e),i=t,r&&(n.add?_.isUndefined(n.at)?i=r.concat(t):(i=r,i.splice.apply(i,[n.at,0].concat(t))):(_.each(i,function(e){e.__detach=!0}),_.each(r,function(e){e.__detach?e.$el.detach():e.remove()}),_.each(i,function(e){delete e.__detach}))),this._views[e]=i,_.each(t,function(t){var n=t.Views||wp.Backbone.Subviews,r=t.views=t.views||new n(t);r.parent=this.view,r.selector=e},this),n.silent||this._attach(e,t,_.extend({ready:this._isReady()},n)),this},add:function(e,t,n){return _.isString(e)||(n=t,t=e,e=""),this.set(e,t,_.extend({add:!0},n))},unset:function(e,t,n){var r;return _.isString(e)||(n=t,t=e,e=""),t=t||[],(r=this.get(e))&&(t=_.isArray(t)?t:[t],this._views[e]=t.length?_.difference(r,t):[]),n&&n.silent||_.invoke(t,"remove"),this},detach:function(){return e(_.pluck(this.all(),"el")).detach(),this},render:function(){var e={ready:this._isReady()};return _.each(this._views,function(t,n){this._attach(n,t,e)},this),this.rendered=!0,this},remove:function(e){return e&&e.silent||(this.parent&&this.parent.views&&this.parent.views.unset(this.selector,this.view,{silent:!0}),delete this.parent,delete this.selector),_.invoke(this.all(),"remove"),this._views=[],this},replace:function(e,t){return e.html(t),this},insert:function(e,t,n){var r,i=n&&n.at;return _.isNumber(i)&&(r=e.children()).length>i?r.eq(i).before(t):e.append(t),this},ready:function(){this.view.trigger("ready"),_.chain(this.all()).map(function(e){return e.views}).flatten().where({attached:!0}).invoke("ready")},_attach:function(e,t,n){var r,i=e?this.view.$(e):this.view.$el;return i.length?(r=_.chain(t).pluck("views").flatten().value(),_.each(r,function(e){e.rendered||(e.view.render(),e.rendered=!0)},this),this[n.add?"insert":"replace"](i,_.pluck(t,"el"),n),_.each(r,function(e){e.attached=!0,n.ready&&e.ready()},this),this):this},_isReady:function(){for(var e=this.view.el;e;){if(e===document.body)return!0;e=e.parentNode}return!1}}),wp.Backbone.View=Backbone.View.extend({Subviews:wp.Backbone.Subviews,constructor:function(){this.views=new this.Subviews(this,this.views),this.on("ready",this.ready,this),Backbone.View.apply(this,arguments)},remove:function(){var e=Backbone.View.prototype.remove.apply(this,arguments);return this.views&&this.views.remove(),e},render:function(){var e;return this.prepare&&(e=this.prepare()),this.views.detach(),this.template&&(e=e||{},this.trigger("prepare",e),this.$el.html(this.template(e))),this.views.render(),this},prepare:function(){return this.options},ready:function(){}})}(jQuery);