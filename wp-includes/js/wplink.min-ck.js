var wpLink;!function(e){var t,n,r,i={},s={};wpLink={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",init:function(){i.dialog=e("#wp-link"),i.submit=e("#wp-link-submit"),i.url=e("#url-field"),i.nonce=e("#_ajax_linking_nonce"),i.title=e("#link-title-field"),i.openInNewTab=e("#link-target-checkbox"),i.search=e("#search-field"),s.search=new n(e("#search-results")),s.recent=new n(e("#most-recent-results")),s.elements=e(".query-results",i.dialog),i.dialog.keydown(wpLink.keydown),i.dialog.keyup(wpLink.keyup),i.submit.click(function(e){e.preventDefault(),wpLink.update()}),e("#wp-link-cancel").click(function(e){e.preventDefault(),wpLink.close()}),e("#internal-toggle").click(wpLink.toggleInternalLinking),s.elements.bind("river-select",wpLink.updateFields),i.search.keyup(wpLink.searchInternalLinks),i.dialog.bind("wpdialogrefresh",wpLink.refresh),i.dialog.bind("wpdialogbeforeopen",wpLink.beforeOpen),i.dialog.bind("wpdialogclose",wpLink.onClose)},beforeOpen:function(){wpLink.range=null,!wpLink.isMCE()&&document.selection&&(wpLink.textarea.focus(),wpLink.range=document.selection.createRange())},open:function(){wpActiveEditor&&(this.textarea=e("#"+wpActiveEditor).get(0),i.dialog.data("wpdialog")||i.dialog.wpdialog({title:wpLinkL10n.title,width:480,height:"auto",modal:!0,dialogClass:"wp-dialog"}),i.dialog.wpdialog("open"))},isMCE:function(){return tinyMCEPopup&&(t=tinyMCEPopup.editor)&&!t.isHidden()},refresh:function(){s.search.refresh(),s.recent.refresh(),wpLink.isMCE()?wpLink.mceRefresh():wpLink.setDefaultValues(),i.url.focus()[0].select(),s.recent.ul.children().length||s.recent.ajax()},mceRefresh:function(){var e;t=tinyMCEPopup.editor,tinyMCEPopup.restoreSelection(),(e=t.dom.getParent(t.selection.getNode(),"A"))?(i.url.val(t.dom.getAttrib(e,"href")),i.title.val(t.dom.getAttrib(e,"title")),i.openInNewTab.prop("checked","_blank"==t.dom.getAttrib(e,"target")),i.submit.val(wpLinkL10n.update)):wpLink.setDefaultValues()},close:function(){wpLink.isMCE()?tinyMCEPopup.close():i.dialog.wpdialog("close")},onClose:function(){wpLink.isMCE()||(wpLink.textarea.focus(),wpLink.range&&(wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select()))},getAttrs:function(){return{href:i.url.val(),title:i.title.val(),target:i.openInNewTab.prop("checked")?"_blank":""}},update:function(){wpLink.isMCE()?wpLink.mceUpdate():wpLink.htmlUpdate()},htmlUpdate:function(){var e,t,n,r,i,s,o=wpLink.textarea;o&&(e=wpLink.getAttrs(),e.href&&"http://"!=e.href&&(t='<a href="'+e.href+'"',e.title&&(t+=' title="'+e.title+'"'),e.target&&(t+=' target="'+e.target+'"'),t+=">",document.selection&&wpLink.range?(o.focus(),wpLink.range.text=t+wpLink.range.text+"</a>",wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select(),wpLink.range=null):"undefined"!=typeof o.selectionStart&&(n=o.selectionStart,r=o.selectionEnd,s=o.value.substring(n,r),t=t+s+"</a>",i=n+t.length,n==r&&(i-="</a>".length),o.value=o.value.substring(0,n)+t+o.value.substring(r,o.value.length),o.selectionStart=o.selectionEnd=i),wpLink.close(),o.focus()))},mceUpdate:function(){var t,n,r=tinyMCEPopup.editor,i=wpLink.getAttrs();return tinyMCEPopup.restoreSelection(),t=r.dom.getParent(r.selection.getNode(),"A"),i.href&&"http://"!=i.href?(null==t?(r.getDoc().execCommand("unlink",!1,null),tinyMCEPopup.execCommand("mceInsertLink",!1,"#mce_temp_url#",{skip_undo:1}),tinymce.each(r.dom.select("a"),function(e){"#mce_temp_url#"==r.dom.getAttrib(e,"href")&&(t=e,r.dom.setAttribs(t,i))}),tinymce.isWebKit&&"#mce_temp_url#"==e(t).text()&&(r.dom.remove(t),t=null)):r.dom.setAttribs(t,i),!t||1==t.childNodes.length&&"IMG"==t.firstChild.nodeName||(r.selection.select(t),r.selection.collapse(0),tinyMCEPopup.storeSelection()),r.execCommand("mceEndUndoLevel"),wpLink.close(),r.focus(),void 0):(t&&(n=r.selection.getBookmark(),r.dom.remove(t,1),r.selection.moveToBookmark(n),tinyMCEPopup.execCommand("mceEndUndoLevel"),wpLink.close()),void 0)},updateFields:function(e,t,n){i.url.val(t.children(".item-permalink").val()),i.title.val(t.hasClass("no-title")?"":t.children(".item-title").text()),n&&"click"==n.type&&i.url.focus()},setDefaultValues:function(){i.url.val("http://"),i.title.val(""),i.submit.val(wpLinkL10n.save)},searchInternalLinks:function(){var t,n=e(this),r=n.val();if(r.length>2){if(s.recent.hide(),s.search.show(),wpLink.lastSearch==r)return;wpLink.lastSearch=r,t=n.parent().find(".spinner").show(),s.search.change(r),s.search.ajax(function(){t.hide()})}else s.search.hide(),s.recent.show()},next:function(){s.search.next(),s.recent.next()},prev:function(){s.search.prev(),s.recent.prev()},keydown:function(t){var n,r=e.ui.keyCode;(t.which===r.UP||t.which===r.DOWN)&&(n=t.which===r.UP?"prev":"next",clearInterval(wpLink.keyInterval),wpLink[n](),wpLink.keyInterval=setInterval(wpLink[n],wpLink.keySensitivity),t.preventDefault())},keyup:function(t){var n=e.ui.keyCode;return t.which===n.ESCAPE?(t.stopImmediatePropagation(),e(document).triggerHandler("wp_CloseOnEscape",[{event:t,what:"wplink",cb:wpLink.close}])||wpLink.close(),!1):((t.which===n.UP||t.which===n.DOWN)&&(clearInterval(wpLink.keyInterval),t.preventDefault()),void 0)},delayedCallback:function(e,t){var n,r,i,s;return t?(setTimeout(function(){return r?e.apply(s,i):(n=!0,void 0)},t),function(){return n?e.apply(this,arguments):(i=arguments,s=this,r=!0,void 0)}):e},toggleInternalLinking:function(t){var n=e("#search-panel"),r=i.dialog.wpdialog("widget"),s=!n.is(":visible"),o=e(window);e(this).toggleClass("toggle-arrow-active",s),i.dialog.height("auto"),n.slideToggle(300,function(){setUserSetting("wplink",s?"1":"0"),i[s?"search":"url"].focus();var e=o.scrollTop(),t=r.offset().top,n=t+r.outerHeight(),u=n-o.height();u>e&&r.animate({top:t>u?t-u:e},200)}),t.preventDefault()}},n=function(t,n){var r=this;this.element=t,this.ul=t.children("ul"),this.waiting=t.find(".river-waiting"),this.change(n),this.refresh(),t.scroll(function(){r.maybeLoad()}),t.delegate("li","click",function(t){r.select(e(this),t)})},e.extend(n.prototype,{refresh:function(){this.deselect(),this.visible=this.element.is(":visible")},show:function(){this.visible||(this.deselect(),this.element.show(),this.visible=!0)},hide:function(){this.element.hide(),this.visible=!1},select:function(e,t){var n,r,i,s;e.hasClass("unselectable")||e==this.selected||(this.deselect(),this.selected=e.addClass("selected"),n=e.outerHeight(),r=this.element.height(),i=e.position().top,s=this.element.scrollTop(),0>i?this.element.scrollTop(s+i):i+n>r&&this.element.scrollTop(s+i-r+n),this.element.trigger("river-select",[e,t,this]))},deselect:function(){this.selected&&this.selected.removeClass("selected"),this.selected=!1},prev:function(){if(this.visible){var e;this.selected&&(e=this.selected.prev("li"),e.length&&this.select(e))}},next:function(){if(this.visible){var t=this.selected?this.selected.next("li"):e("li:not(.unselectable):first",this.element);t.length&&this.select(t)}},ajax:function(e){var t=this,n=1==this.query.page?0:wpLink.minRiverAJAXDuration,r=wpLink.delayedCallback(function(n,r){t.process(n,r),e&&e(n,r)},n);this.query.ajax(r)},change:function(e){this.query&&this._search==e||(this._search=e,this.query=new r(e),this.element.scrollTop(0))},process:function(t,n){var r="",i=!0,s="",o=1==n.page;t?e.each(t,function(){s=i?"alternate":"",s+=this.title?"":" no-title",r+=s?'<li class="'+s+'">':"<li>",r+='<input type="hidden" class="item-permalink" value="'+this.permalink+'" />',r+='<span class="item-title">',r+=this.title?this.title:wpLinkL10n.noTitle,r+='</span><span class="item-info">'+this.info+"</span></li>",i=!i}):o&&(r+='<li class="unselectable"><span class="item-title"><em>'+wpLinkL10n.noMatchesFound+"</em></span></li>"),this.ul[o?"html":"append"](r)},maybeLoad:function(){var e=this,t=this.element,n=t.scrollTop()+t.height();!this.query.ready()||n<this.ul.height()-wpLink.riverBottomThreshold||setTimeout(function(){var n=t.scrollTop(),r=n+t.height();!e.query.ready()||r<e.ul.height()-wpLink.riverBottomThreshold||(e.waiting.show(),t.scrollTop(n+e.waiting.outerHeight()),e.ajax(function(){e.waiting.hide()}))},wpLink.timeToTriggerRiver)}}),r=function(e){this.page=1,this.allLoaded=!1,this.querying=!1,this.search=e},e.extend(r.prototype,{ready:function(){return!this.querying&&!this.allLoaded},ajax:function(t){var n=this,r={action:"wp-link-ajax",page:this.page,_ajax_linking_nonce:i.nonce.val()};this.search&&(r.search=this.search),this.querying=!0,e.post(ajaxurl,r,function(e){n.page++,n.querying=!1,n.allLoaded=!e,t(e,r)},"json")}}),e(document).ready(wpLink.init)}(jQuery);